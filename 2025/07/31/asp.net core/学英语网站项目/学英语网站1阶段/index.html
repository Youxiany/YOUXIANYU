<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>搭建英语网站第一阶段 | YOUXIANYU</title><meta name="author" content="YOUXIANYU"><meta name="copyright" content="YOUXIANYU"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="网站结构说明学习杨中科老师开源项目在线英语网站微服务  功能：听力练习。 业务概念：类别（Category）、专辑（Album）、片段（Episode）。 听力原文字幕文件查看。 网站后台允许进行资源的CRUD。 其他格式的音频的追踪在部分浏览器上有问题，统一用M4A。 音频文件放到单独的文件服务器上。 原文的搜素。   项目结构说明为了便于管理，我们把不同服务的项目放到不同的解决方案文件夹下，解">
<meta property="og:type" content="article">
<meta property="og:title" content="搭建英语网站第一阶段">
<meta property="og:url" content="http://example.com/2025/07/31/asp.net%20core/%E5%AD%A6%E8%8B%B1%E8%AF%AD%E7%BD%91%E7%AB%99%E9%A1%B9%E7%9B%AE/%E5%AD%A6%E8%8B%B1%E8%AF%AD%E7%BD%91%E7%AB%991%E9%98%B6%E6%AE%B5/index.html">
<meta property="og:site_name" content="YOUXIANYU">
<meta property="og:description" content="网站结构说明学习杨中科老师开源项目在线英语网站微服务  功能：听力练习。 业务概念：类别（Category）、专辑（Album）、片段（Episode）。 听力原文字幕文件查看。 网站后台允许进行资源的CRUD。 其他格式的音频的追踪在部分浏览器上有问题，统一用M4A。 音频文件放到单独的文件服务器上。 原文的搜素。   项目结构说明为了便于管理，我们把不同服务的项目放到不同的解决方案文件夹下，解">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/youxin/net.jpg">
<meta property="article:published_time" content="2025-07-30T16:00:00.000Z">
<meta property="article:modified_time" content="2025-08-02T03:25:18.660Z">
<meta property="article:author" content="YOUXIANYU">
<meta property="article:tag" content="ASP.NET Core">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/youxin/net.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "搭建英语网站第一阶段",
  "url": "http://example.com/2025/07/31/asp.net%20core/%E5%AD%A6%E8%8B%B1%E8%AF%AD%E7%BD%91%E7%AB%99%E9%A1%B9%E7%9B%AE/%E5%AD%A6%E8%8B%B1%E8%AF%AD%E7%BD%91%E7%AB%991%E9%98%B6%E6%AE%B5/",
  "image": "http://example.com/img/youxin/net.jpg",
  "datePublished": "2025-07-30T16:00:00.000Z",
  "dateModified": "2025-08-02T03:25:18.660Z",
  "author": [
    {
      "@type": "Person",
      "name": "YOUXIANYU",
      "url": "http://example.com/"
    }
  ]
}</script><link rel="shortcut icon" href="/%5Cimg%5Cc.c.jpg"><link rel="canonical" href="http://example.com/2025/07/31/asp.net%20core/%E5%AD%A6%E8%8B%B1%E8%AF%AD%E7%BD%91%E7%AB%99%E9%A1%B9%E7%9B%AE/%E5%AD%A6%E8%8B%B1%E8%AF%AD%E7%BD%91%E7%AB%991%E9%98%B6%E6%AE%B5/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><link rel="stylesheet" href="https://fonts.font.im/css?family=Didact+Gothic|Fredoka+One" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'medium_zoom',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '搭建英语网站第一阶段',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="https://at.alicdn.com/t/c/font_5000759_6ezv40qb1v2.css?spm=a313x.manage_type_myprojects.i1.9.6ca73a81PmQR53&file=font_5000759_6ezv40qb1v2.css"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-footer-beautify@1.0.0/lib/runtime.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.0.0"></head><body><div id="web_bg" style="background: var();"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/%5Cimg%5Cc.c.jpg" onerror="this.onerror=null;this.src='/img/loading.svg'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">141</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">34</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">28</div></a></div><div class="menus_items"><div class="menus_item"><span class="site-page group hide"><i class="fa-fw iconfont icon-pencil-01"></i><span> 工具</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.feijipan.com"><i class="fa-fw iconfont icon-zhifeiji-copy"></i><span> 小飞机网盘</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://snake.timeline.ink/latest"><i class="fa-fw iconfont icon-bizhishezhi"></i><span> 拾光壁纸</span></a></li><li><a class="site-page child" href="/tool/mcstate"><i class="fa-fw iconfont icon-minecraft"></i><span> MC状态</span></a></li></ul></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw iconfont icon-wenzhang"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-guidang"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-biaoqian"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-fenlei"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw iconfont icon-icon-shishi"></i><span> 笔记</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/categories/%E9%97%B2%E8%B0%88/"><i class="fa-fw iconfont icon-kele"></i><span> 闲谈</span></a></li><li><a class="site-page child" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><i class="fa-fw iconfont icon-daima"></i><span> 技术</span></a></li><li><a class="site-page child" href="/2024/07/18/Butterfly%E4%B8%BB%E9%A2%98%E9%AD%94%E6%94%B9%E6%97%A5%E5%BF%97/"><i class="fa-fw iconfont icon-fuwurizhi"></i><span> 日志</span></a></li></ul></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw iconfont icon-shejiaotubiao-26"></i><span> 社交</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw iconfont icon-lianjie"></i><span> 友人帐</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://travel.moe/go.html?travel=on"><i class="fa-fw iconfont icon-ditie"></i><span> 开往</span></a></li></ul></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw iconfont icon-shoucang"></i><span> 我的</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/album/"><i class="fa-fw iconfont icon-xiangce"></i><span> 相册</span></a></li><li><a class="site-page child" href="/equipment/"><i class="fa-fw iconfont icon-backpack"></i><span> 装备</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw iconfont icon-guanyu"></i><span> 关于</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background: img\youxin\net.jpg;"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">YOUXIANYU</span></a><a class="nav-page-title" href="/"><span class="site-name">搭建英语网站第一阶段</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><span class="site-page group hide"><i class="fa-fw iconfont icon-pencil-01"></i><span> 工具</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.feijipan.com"><i class="fa-fw iconfont icon-zhifeiji-copy"></i><span> 小飞机网盘</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://snake.timeline.ink/latest"><i class="fa-fw iconfont icon-bizhishezhi"></i><span> 拾光壁纸</span></a></li><li><a class="site-page child" href="/tool/mcstate"><i class="fa-fw iconfont icon-minecraft"></i><span> MC状态</span></a></li></ul></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw iconfont icon-wenzhang"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw iconfont icon-guidang"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw iconfont icon-biaoqian"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw iconfont icon-fenlei"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw iconfont icon-icon-shishi"></i><span> 笔记</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/categories/%E9%97%B2%E8%B0%88/"><i class="fa-fw iconfont icon-kele"></i><span> 闲谈</span></a></li><li><a class="site-page child" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><i class="fa-fw iconfont icon-daima"></i><span> 技术</span></a></li><li><a class="site-page child" href="/2024/07/18/Butterfly%E4%B8%BB%E9%A2%98%E9%AD%94%E6%94%B9%E6%97%A5%E5%BF%97/"><i class="fa-fw iconfont icon-fuwurizhi"></i><span> 日志</span></a></li></ul></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw iconfont icon-shejiaotubiao-26"></i><span> 社交</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw iconfont icon-lianjie"></i><span> 友人帐</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://travel.moe/go.html?travel=on"><i class="fa-fw iconfont icon-ditie"></i><span> 开往</span></a></li></ul></div><div class="menus_item"><span class="site-page group hide"><i class="fa-fw iconfont icon-shoucang"></i><span> 我的</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/album/"><i class="fa-fw iconfont icon-xiangce"></i><span> 相册</span></a></li><li><a class="site-page child" href="/equipment/"><i class="fa-fw iconfont icon-backpack"></i><span> 装备</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw iconfont icon-guanyu"></i><span> 关于</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">搭建英语网站第一阶段</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-07-30T16:00:00.000Z" title="发表于 2025-07-31 00:00:00">2025-07-31</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-08-02T03:25:18.660Z" title="更新于 2025-08-02 11:25:18">2025-08-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/NET/">NET</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">9.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>38分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="网站结构说明"><a href="#网站结构说明" class="headerlink" title="网站结构说明"></a>网站结构说明</h1><p><b>学习杨中科老师开源项目在线英语网站微服务</b></p>
<ol>
<li>功能：听力练习。</li>
<li>业务概念：类别（Category）、专辑（Album）、片段（Episode）。</li>
<li>听力原文字幕文件查看。</li>
<li>网站后台允许进行资源的CRUD。</li>
<li>其他格式的音频的追踪在部分浏览器上有问题，统一用M4A。</li>
<li>音频文件放到单独的文件服务器上。</li>
<li>原文的搜素。</li>
</ol>
<p><img src="/img%5Cwz.png"></p>
<h1 id="项目结构说明"><a href="#项目结构说明" class="headerlink" title="项目结构说明"></a>项目结构说明</h1><p>为了便于管理，我们把不同服务的项目放到不同的解决方案文件夹下，解决方案文件夹Commons下的项目是一些公用的类库。<br>各服务的解决方案文件夹下都包含Domain、Infrastucture、WebAPI这3个项目，它们分别对应领域层、基础设施层、应用服务层。听力网站前台和听力网站后台共享相同的领域层和基础设施层，因此在解决方案文件夹Listening下有4个项目。<br>因为所有的项目都用到了领域事件、集成事件、中心配置服务器、JWT、工作单元、CORS、FluentValidation等，创建Commonlnitializer项目来复用这些组件的初始化代码。</p>
<p>有一点需要特别注意，如果我们创建的是ASP.NET Core项目，在项目中我们可以使用WebApplicationBuilder、IApplicationBuilder、IWebHostEnvironment等类型，但是在类库项目中我们则不能直接使用这些类型。这些类型都定义在Microsoft.AspNetCore.Hosting.Abstractions、Microsoft.AspNetCore等程序集中，版本非常低，ASP.NET Core的包不在单独发布到NuGet中，而是直接内建在.NET Core SDK中。如果想在ASP.NET Core中引用这些ASP.NET Core的类型，请在csproj中添加&lt;FrameworkReference Include&#x3D;”Microsoft.AspNetCore.App”&#x2F;&gt;。</p>
<h1 id="项目运行环境搭建"><a href="#项目运行环境搭建" class="headerlink" title="项目运行环境搭建"></a>项目运行环境搭建</h1><p>这个项目使用Microsoft SQL Server作为数据库服务器、用Nginx作为网关、用Redis实现分布式缓存、用RabbitMQ实现领域事件、用Elasticsearch作为搜索引擎服务器。</p>
<p>第一步，在生产环境下，我们一般会把不同的服务放到不同的服务器上，因此不会出现多个ASP.NET Core网站同时运行造成的端口冲突问题，但是如果我们需要在Visual Studio中同时运行多个ASP.NET Core项目，就可能会遇到这些项目的端口冲突的问题。如果我们用Visual Studio中的IIS Express来运行网站的话，可以修改ASP.NET Core项目的Properties文件夹下的launchSettings.json文件，在iisExpress节点下配置指定项目运行的端口。<br><img src="/img%5C%E7%BD%91%E5%9D%80%5C15.png"></p>
<p>我们分别让FileService.WebAPI、IdentityService.WebAPI、Listening.Admin.WebAPI、Listening.Main.WebAPI、MediaEncoder.WebAPI、SearchService.WebAPI运行在44339、44392、44352、44375、44353、44310端口下。</p>
<p>第二步，为了统一前端访问后端的不同服务的接口，我们配置Nginx来反向代理后端的接口。我们在nginx的nginx.conf文件中的server节点下增加代码。</p>
<p><img src="/img%5C%E7%BD%91%E5%9D%80%5C16.png"></p>
<p><b>配置nginx,这里端口号一定要和你的swagger端口号统一，因为你不是用iis，其次就是跨域的话，默认swagger的url有2个,只能留一个<b><br>假设你的 Swagger 服务运行在127.0.0.1:8080，Nginx 配置如下：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;  <span class="comment"># 对外暴露的端口，可根据需要修改</span></span><br><span class="line">    <span class="attribute">server_name</span> localhost;  <span class="comment"># 你的域名或服务器IP</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 代理到Swagger服务，确保端口一致</span></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://127.0.0.1:8080;  <span class="comment"># 与Swagger服务端口保持一致</span></span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        location /FileService/&#123;</span><br><span class="line">            proxy_pass http://localhost:44339/;</span><br><span class="line">            proxy_set_header Host $host;</span><br><span class="line">            proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">            proxy_set_header X-Real-PORT $remote_port;</span><br><span class="line">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">            proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line">            client_max_body_size 100m;  </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location /IdentityService/&#123;</span><br><span class="line">            proxy_pass http://localhost:44392/;</span><br><span class="line">            proxy_set_header Host $host;</span><br><span class="line">            proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">            proxy_set_header X-Real-PORT $remote_port;</span><br><span class="line">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">            proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location /Listening.Admin/&#123;</span><br><span class="line">            proxy_pass http://localhost:44352/;</span><br><span class="line">            proxy_set_header Host $host;</span><br><span class="line">            proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">            proxy_set_header X-Real-PORT $remote_port;</span><br><span class="line">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">            proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line">            proxy_http_version 1.1;</span><br><span class="line">            proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">            proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        localhost /Listening.Main/&#123;</span><br><span class="line">            proxy_pass http://localhost:44375/;</span><br><span class="line">            proxy_set_header Host $host;</span><br><span class="line">            proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">            proxy_set_header X-Real-PORT $remote_port;</span><br><span class="line">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">            proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        localhost /MediaEncoder/&#123;</span><br><span class="line">            proxy_pass http://localhost:44353/;</span><br><span class="line">            proxy_set_header Host $host;</span><br><span class="line">            proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">            proxy_set_header X-Real-PORT $remoto_port;</span><br><span class="line">            proxy_set_header X-For-For $proxy_add_x_forwarded_for;</span><br><span class="line">            proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location /SearchService/&#123;</span><br><span class="line">            proxy_pass http://localhost:44310/;</span><br><span class="line">            proxy_set_header Host $host;</span><br><span class="line">            proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">            proxy_set_header X-Real-PORT $remote_port;</span><br><span class="line">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">            proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        #charset koi8-r;</span><br><span class="line"></span><br><span class="line">        #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>上面配置的proxy_set_header是用来方便我们在ASP.NET Core中获取客户端IP地址的，需要配合ForwardedHeaders中间件使用。<br>配置完Nginx后，只要重启Nginx服务器即可让配置生效，然后我们访问<a target="_blank" rel="noopener" href="https://localhost/IdentityService/%E5%B0%B1%E5%8F%AF%E4%BB%A5%E8%AE%BF%E9%97%AEIdentityService%E7%9A%84%E6%8E%A5%E5%8F%A3%E4%BA%86%EF%BC%8C%E8%BF%99%E6%A0%B7%E5%89%8D%E7%AB%AF%E5%B0%B1%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E7%BB%9F%E4%B8%80%E7%9A%84%E7%AB%AF%E5%8F%A3%E6%9D%A5%E8%AE%BF%E9%97%AE%E5%90%8E%E7%AB%AF%E6%9C%8D%E5%8A%A1%E3%80%82">https://localhost/IdentityService/就可以访问IdentityService的接口了，这样前端就可以通过统一的端口来访问后端服务。</a></p>
<p>第三步，CommonInitializer中的初始化代码是设定从“DefaultDB:ConnStr”路径中读取数据库的连接字符串，因此请在环境变量中配置名字为DefaultDB:ConnStr的数据库连接字符串，然后在各个项目中运行EF Core数据库迁移来生成数据库表。<br><img src="/img%5C%E7%BD%91%E5%9D%80%5C17.png"></p>
<p>第四步，我们在数据库中增加一个名字为T_Configs的表，并且在表中增加如下配置。<br><img src="/img%5C%E7%BD%91%E5%9D%80%5C18.png"></p>
<p>Cors的配置项为项目的跨域设置。<br>FileService:SMB的配置项为文件备份服务器的根目录。<br>Redis的配置项为Redis服务器的连接配置。<br>RabbitMQ的配置项为集成事件相关RabbitMQ的配置，HostName属性为服务器的地址，ExchangeName属性为集成事件的交换机名字。<br>ElasticSearch的配置项为ElasticSearch服务器的配置，其中的用户名、密码需要和读者安装的ElasticSearch服务器的配置一致。<br>JWT的配置项为登录令牌的JWT配置。</p>
<h1 id="Commons"><a href="#Commons" class="headerlink" title="Commons"></a>Commons</h1><p>一些项目初始化的代码放到这里，项目里通用的东西放到Commons解决方案文件夹下</p>
<p><img src="/img%5C%E7%BD%91%E5%9D%80%5CCommons.png"></p>
<h3 id="项目源码"><a href="#项目源码" class="headerlink" title="项目源码"></a>项目源码</h3><table border="1" cellspacing="0">
<tr>
<td>项目</td>
<td>类</td>
<td>说明</td>
</tr>
<tr>
<td>YU.ASPNETCore</td>
<td>DistributedCacheHelper</td>
<td>分布式缓存帮助类</td>
</tr>
<tr>
<td>YU.Commons</td>
<td>验证器文件夹</td>
<td>FluentValidation的扩展类</td>
</tr>
<tr>
<td>YU.DomainCommons</td>
<td>IAggregateRoot</td>
<td>聚合根标识接口</td>
</tr>
<tr>
<td>YU.EventBus</td>
<td>订阅、撤销、发布事件</td>
<td>集成事件总线</td>
</tr>
<tr>
<td>YU.Infrastructure</td>
<td>BaseDbContext</td>
<td>领域事件的发布</td>
</tr>
<tr>
<td>YU.JWT</td>
<td>Token</td>
<td>使用JWT实现登录令牌</td>
</tr>
</table>


<h2 id="所用到的NuGet包"><a href="#所用到的NuGet包" class="headerlink" title="所用到的NuGet包"></a>所用到的NuGet包</h2><p><img src="/img%5C%E7%BD%91%E5%9D%80%5C19.png"></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;ItemGroup&gt;</span><br><span class="line"> &lt;FrameworkReference Include=<span class="string">&quot;Microsoft.AspNetCore.App&quot;</span> /&gt;</span><br><span class="line"> &lt;PackageReference Include=<span class="string">&quot;FluentValidation&quot;</span> Version=<span class="string">&quot;12.0.0&quot;</span> /&gt;</span><br><span class="line"> &lt;PackageReference Include=<span class="string">&quot;FluentValidation.DependencyInjectionExtensions&quot;</span> Version=<span class="string">&quot;12.0.0&quot;</span> /&gt;</span><br><span class="line"> &lt;PackageReference Include=<span class="string">&quot;MediatR&quot;</span> Version=<span class="string">&quot;8.1.0&quot;</span> /&gt;</span><br><span class="line">  &lt;PackageReference Include=<span class="string">&quot;Microsoft.AspNetCore.Http.Abstractions&quot;</span> Version=<span class="string">&quot;2.3.0&quot;</span> /&gt;</span><br><span class="line">  &lt;PackageReference Include=<span class="string">&quot;Microsoft.EntityFrameworkCore&quot;</span> Version=<span class="string">&quot;8.0.18&quot;</span> /&gt;</span><br><span class="line">  &lt;PackageReference Include=<span class="string">&quot;Microsoft.EntityFrameworkCore.SqlServer&quot;</span> Version=<span class="string">&quot;8.0.18&quot;</span> /&gt;</span><br><span class="line">  &lt;PackageReference Include=<span class="string">&quot;Microsoft.Extensions.DependencyInjection&quot;</span> Version=<span class="string">&quot;9.0.7&quot;</span> /&gt;</span><br><span class="line">  &lt;PackageReference Include=<span class="string">&quot;Serilog.AspNetCore&quot;</span> Version=<span class="string">&quot;8.0.3&quot;</span> /&gt;</span><br><span class="line">  &lt;PackageReference Include=<span class="string">&quot;StackExchange.Redis&quot;</span> Version=<span class="string">&quot;2.8.58&quot;</span> /&gt;</span><br><span class="line">  &lt;PackageReference Include=<span class="string">&quot;Swashbuckle.AspNetCore.SwaggerGen&quot;</span> Version=<span class="string">&quot;8.1.4&quot;</span> /&gt;</span><br><span class="line">  &lt;PackageReference Include=<span class="string">&quot;Zack.AnyDBConfigProvider&quot;</span> Version=<span class="string">&quot;1.1.4&quot;</span> /&gt;</span><br><span class="line">&lt;/ItemGroup&gt;</span><br></pre></td></tr></table></figure>

<h2 id="ApplicationBuilderExtensions"><a href="#ApplicationBuilderExtensions" class="headerlink" title="ApplicationBuilderExtensions"></a>ApplicationBuilderExtensions</h2><p>首现我们创建一个Commonlnitializer类库项目，在csproj中添加&lt;FrameworkReference Include&#x3D;”Microsoft.AspNetCore.App”&#x2F;&gt;这个类库把我们所有需要用到的配置领域事件、集成事件、中心配置服务器、JWT、工作单元、CORS、FluentValidation等，用来复用。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Commonlnitializer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 提供对IApplicationBuilder的扩展方法，用于配置应用的默认中间件。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">ApplicationBuilderExtensions</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 配置应用的默认中间件，包括事件总线、CORS、转发头、认证和授权。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;app&quot;&gt;</span>IApplicationBuilder 实例。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>配置后的 IApplicationBuilder 实例。<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IApplicationBuilder <span class="title">UseZackDefault</span>(<span class="params"><span class="keyword">this</span> IApplicationBuilder app</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            app.UseEventBus(); <span class="comment">// 启用事件总线</span></span><br><span class="line">            app.UseCors(); <span class="comment">// 启用跨域资源共享（CORS）</span></span><br><span class="line">            app.UseForwardedHeaders(); <span class="comment">// 处理代理服务器转发的头信息</span></span><br><span class="line">            <span class="comment">//app.UseHttpsRedirection();//不能与ForwardedHeaders很好的工作，而且webapi项目也没必要配置这个</span></span><br><span class="line">            app.UseAuthentication(); <span class="comment">// 启用认证</span></span><br><span class="line">            app.UseAuthorization(); <span class="comment">// 启用授权</span></span><br><span class="line">            <span class="keyword">return</span> app;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UseEventBus在应用程序中启用事件总线，是我们给IApplicationBuilder类扩展的方法，是检查是否事件总线服务是否注册如果未注册，将抛出异常提醒开发者。<br>app.UseForwardedHeaders(); 获取Nignx的原始客户端的 IP 地址，原始请求的协议（HTTP 或 HTTPS），原始主机地址</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">YU.EventBus</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 提供扩展方法，用于在应用程序中启用事件总线功能。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">ApplicationBuilderExtensions</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 启用事件总线功能。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 该方法会检查事件总线服务（IEventBus）是否已注册。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 如果未注册，将抛出异常提醒开发者。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;appBuilder&quot;&gt;</span>应用程序构建器对象。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>返回原始的应用程序构建器对象，便于链式调用。<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;ApplicationException&quot;&gt;</span>如果未找到IEventBus的实现，则抛出异常。<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IApplicationBuilder <span class="title">UseEventBus</span>(<span class="params"><span class="keyword">this</span> IApplicationBuilder appBuilder</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 尝试从依赖注入容器中获取IEventBus服务</span></span><br><span class="line">            <span class="built_in">object</span>? eventBus = appBuilder.ApplicationServices.GetService(<span class="keyword">typeof</span>(IEventBus));</span><br><span class="line">            <span class="keyword">if</span> (eventBus == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 如果没有找到IEventBus的实现，抛出异常，提示开发者需要注册服务</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationException(<span class="string">&quot;找不到IEventBus的实现，请确保已正确注册EventBus服务。&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 返回appBuilder，支持链式调用</span></span><br><span class="line">            <span class="keyword">return</span> appBuilder;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 此扩展方法允许应用程序构建器使用事件总线功能。</span></span><br></pre></td></tr></table></figure>
<p>其中的object? eventBus &#x3D; appBuilder.ApplicationServices.GetService(typeof(IEventBus));在 ASP.NET Core 中从依赖注入（DI）容器获取一个类型为 IEventBus 的事件接口，并赋值给一个 object? 类型的变量 eventBus。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">YU.EventBus</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 事件总线接口，定义了事件的发布与订阅相关操作。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IEventBus</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 发布事件。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;eventName&quot;&gt;</span>事件名称。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;eventData&quot;&gt;</span>事件数据，可以为 null。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">publish</span>(<span class="params"><span class="built_in">string</span> eventName, <span class="built_in">object</span>? eventData</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 订阅指定事件。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;eventName&quot;&gt;</span>事件名称。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;handlerType&quot;&gt;</span>处理该事件的处理器类型。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">Subscribe</span>(<span class="params"><span class="built_in">string</span> eventName, Type handlerType</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 取消订阅指定事件。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;eventName&quot;&gt;</span>事件名称。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;handlerType&quot;&gt;</span>要移除的处理器类型。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">Unsubscribe</span>(<span class="params"><span class="built_in">string</span> eventName, Type handlerType</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>app.UseCors();<br>app.UseForwardedHeaders();<br>app.UseAuthentication();<br>app.UseAuthorization();<br>是Microsoft.AspNetCore.BuilderNuGet包，安装后可直接配置扩展方法，后面的项目可以直接引用。</p>
<h2 id="CorsSettings"><a href="#CorsSettings" class="headerlink" title="CorsSettings"></a>CorsSettings</h2><p>CorsSettings类用于配置 跨域资源共享（CORS）</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Commonlnitializer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 表示跨域资源共享（CORS）相关的配置设置。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CorsSettings</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 允许的跨域来源地址列表。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>[] Origins &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Origins 表示允许跨域请求的来源地址列表（如 <a target="_blank" rel="noopener" href="http://localhost:3000/">http://localhost:3000</a> ）</p>
<h2 id="DbContextOptionsBuilderFactory"><a href="#DbContextOptionsBuilderFactory" class="headerlink" title="DbContextOptionsBuilderFactory"></a>DbContextOptionsBuilderFactory</h2><p>我们创建一个DbContextOptionsBuilderFactory的实用工厂类。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Commonlnitializer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 提供用于创建 <span class="doctag">&lt;see cref=&quot;DbContextOptionsBuilder&#123;TContext&#125;&quot;/&gt;</span> 的工厂方法。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">DbContextOptionsBuilderFactory</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 创建并配置 <span class="doctag">&lt;see cref=&quot;DbContextOptionsBuilder&#123;TDbContext&#125;&quot;/&gt;</span> 实例，使用环境变量 &quot;DefaultDB:ConnStr&quot; 作为连接字符串。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;TDbContext&quot;&gt;</span>要配置的 DbContext 类型。<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>配置好的 <span class="doctag">&lt;see cref=&quot;DbContextOptionsBuilder&#123;TDbContext&#125;&quot;/&gt;</span> 实例。<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="title">DbContextOptionsBuilder</span>&lt;<span class="title">TDbContext</span>&gt; <span class="title">Create</span>&lt;<span class="title">TDbContext</span>&gt;()</span></span><br><span class="line"><span class="function">            <span class="keyword">where</span> TDbContext : DbContext</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 从环境变量获取数据库连接字符串</span></span><br><span class="line">            <span class="keyword">var</span> connStr = Environment.GetEnvironmentVariable(<span class="string">&quot;DefaultDB:ConnStr&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrWhiteSpace(connStr))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidOperationException(<span class="string">&quot;Environment variable &#x27;DefaultDB:ConnStr&#x27; is not set.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 检查连接字符串是否有效</span></span><br><span class="line">            <span class="comment">// 创建 DbContextOptionsBuilder 实例</span></span><br><span class="line">            <span class="keyword">var</span> optionsBuilder = <span class="keyword">new</span> DbContextOptionsBuilder&lt;TDbContext&gt;();</span><br><span class="line">            <span class="comment">// 配置使用 SQL Server 数据库</span></span><br><span class="line">            optionsBuilder.UseSqlServer(connStr);</span><br><span class="line">            <span class="keyword">return</span> optionsBuilder;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DbContextOptionsBuilder&lt;TDbContext&gt; 实例，用于统一创建并配置。<br>var connStr &#x3D; Environment.GetEnvironmentVariable(“DefaultDB:ConnStr”);从环境变量中读取数据库连接字符串，不在appsettings.json，是防止信息的泄露。<br>new DbContextOptionsBuilder&lt;TDbContext&gt;();创建并配置一个DbContextOptionsBuilder 实例。<br>UseSqlServer();指定使用SQL Server数据库。</p>
<h2 id="InitializerOptions"><a href="#InitializerOptions" class="headerlink" title="InitializerOptions"></a>InitializerOptions</h2><p>InitializerOptions类，用于集中配置一些初始化相关的参数，例如日志路径和 EventBus 队列名称。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Commonlnitializer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 初始化选项配置类。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">InitializerOptions</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 日志文件路径。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> LogFilePath &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 用于 EventBus 的队列名称。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 需保证同一项目值保持一致，不同项目不能冲突。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> EventBusQueueName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="WebApplicationBuilderExtensions"><a href="#WebApplicationBuilderExtensions" class="headerlink" title="WebApplicationBuilderExtensions"></a>WebApplicationBuilderExtensions</h2><p>给WebApplicationBuilder提供扩展方法。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Commonlnitializer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 提供 WebApplicationBuilder 的扩展方法。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">WebApplicationBuilderExtensions</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 配置数据库配置源，将数据库中的配置信息添加到应用配置中。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;builder&quot;&gt;</span>WebApplicationBuilder 实例。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ConfigureDbConfiguration</span>(<span class="params"><span class="keyword">this</span> WebApplicationBuilder builder</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 配置主机构建器的应用配置</span></span><br><span class="line">            builder.Host.ConfigureAppConfiguration((hostCtx, configBuilder) =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 从应用配置中获取数据库连接字符串，键为 &quot;DefaultDB:ConnStr&quot;</span></span><br><span class="line">                <span class="built_in">string</span> connStr = builder.Configuration.GetValue&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;DefaultDB:ConnStr&quot;</span>);</span><br><span class="line">                <span class="comment">// 添加自定义的数据库配置源，支持自动刷新，刷新间隔为5秒</span></span><br><span class="line">                configBuilder.AddDbConfiguration(() =&gt; <span class="keyword">new</span> SqlConnection(connStr), reloadOnChange: <span class="literal">true</span>, reloadInterval: TimeSpan.FromSeconds(<span class="number">5</span>));</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 配置应用所需的额外服务，包括数据库、认证、授权、日志、CORS、Redis、事件总线等。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;builder&quot;&gt;</span>WebApplicationBuilder 实例。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;initOptions&quot;&gt;</span>初始化选项，包含日志路径和事件总线队列名等。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ConfigureExtraServices</span>(<span class="params"><span class="keyword">this</span> WebApplicationBuilder builder, InitializerOptions initOptions</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 获取服务集合</span></span><br><span class="line">            IServiceCollection services = builder.Services;</span><br><span class="line">            <span class="comment">// 获取应用配置</span></span><br><span class="line">            IConfiguration configuration = builder.Configuration;</span><br><span class="line">            <span class="comment">// 获取所有引用的程序集，用于后续模块初始化和依赖注入</span></span><br><span class="line">            <span class="keyword">var</span> assemblies = ReflectionHelper.GetAllReferencedAssemblies();</span><br><span class="line">            <span class="comment">// 执行所有模块的初始化方法</span></span><br><span class="line">            services.RunModuleInitializers(assemblies);</span><br><span class="line">            <span class="comment">// 注册所有数据库上下文，使用 SQL Server，连接字符串从配置中获取</span></span><br><span class="line">            services.AddAllDbContexts(ctx =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">string</span> connStr = configuration.GetValue&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;DefaultDB:ConnStr&quot;</span>);</span><br><span class="line">                ctx.UseSqlServer(connStr);</span><br><span class="line">            &#125;, assemblies);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 添加认证服务</span></span><br><span class="line">            builder.Services.AddAuthentication();</span><br><span class="line">            <span class="comment">// 添加授权服务</span></span><br><span class="line">            builder.Services.AddAuthorization();</span><br><span class="line">            <span class="comment">// 从配置中获取 JWT 相关配置</span></span><br><span class="line">            JWTOptions jwtOpt = configuration.GetSection(<span class="string">&quot;JWT&quot;</span>).Get&lt;JWTOptions&gt;();</span><br><span class="line">            <span class="comment">// 添加 JWT 认证服务</span></span><br><span class="line">            builder.Services.AddJWTAuthentication(jwtOpt);</span><br><span class="line">            <span class="comment">// 配置 Swagger，添加认证头部</span></span><br><span class="line">            builder.Services.Configure&lt;SwaggerGenOptions&gt;(c =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                c.AddAuthenticationHeader();</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 注册 MediatR，用于领域事件和命令处理</span></span><br><span class="line">            services.AddMediatR(assemblies);</span><br><span class="line">            <span class="comment">// 配置 MVC 选项，添加工作单元过滤器</span></span><br><span class="line">            services.Configure&lt;MvcOptions&gt;(options =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                options.Filters.Add&lt;UnitOfWorkFilter&gt;();</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">// 配置 JSON 选项，添加自定义的 DateTime 序列化转换器</span></span><br><span class="line">            services.Configure&lt;JsonOptions&gt;(options =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                options.JsonSerializerOptions.Converters.Add(<span class="keyword">new</span> DateTimeJsonConverter(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>));</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 配置跨域资源共享（CORS）策略</span></span><br><span class="line">            services.AddCors(options =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 从配置中获取 CORS 设置</span></span><br><span class="line">                <span class="keyword">var</span> corsOpt = configuration.GetSection(<span class="string">&quot;Cors&quot;</span>).Get&lt;CorsSettings&gt;();</span><br><span class="line">                <span class="comment">// 获取允许的来源列表</span></span><br><span class="line">                <span class="built_in">string</span>[] urls = corsOpt.Origins;</span><br><span class="line">                <span class="comment">// 添加默认策略，允许指定来源、任意头、任意方法，并允许携带凭据</span></span><br><span class="line">                options.AddDefaultPolicy(builder =&gt; builder.WithOrigins(urls)</span><br><span class="line">                    .AllowAnyHeader()</span><br><span class="line">                    .AllowAnyMethod()</span><br><span class="line">                    .AllowCredentials());</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">// 配置日志服务，使用 Serilog，日志输出到控制台和文件</span></span><br><span class="line">            services.AddLogging(builder =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 配置 Serilog 日志记录器</span></span><br><span class="line">                Log.Logger = <span class="keyword">new</span> LoggerConfiguration()</span><br><span class="line">                .WriteTo.Console()</span><br><span class="line">                .WriteTo.File(initOptions.LogFilePath)</span><br><span class="line">                .CreateLogger();</span><br><span class="line">                <span class="comment">// 将 Serilog 集成到日志系统</span></span><br><span class="line">                builder.AddSerilog();</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">// 获取应用程序主程序集，用于注册 FluentValidation 验证器</span></span><br><span class="line">            <span class="keyword">var</span> applicationAssembly = <span class="keyword">typeof</span>(UserModelValidator).Assembly;</span><br><span class="line">            <span class="comment">// 注册所有验证器</span></span><br><span class="line">            services.AddValidatorsFromAssembly(applicationAssembly);</span><br><span class="line">            <span class="comment">// 配置 JWT 选项绑定</span></span><br><span class="line">            services.Configure&lt;JWTOptions&gt;(configuration.GetSection(<span class="string">&quot;JWT&quot;</span>));</span><br><span class="line">            <span class="comment">// 配置 RabbitMQ 事件总线选项绑定</span></span><br><span class="line">            services.Configure&lt;IntegrationEventRabbitMQOptions&gt;(configuration.GetSection(<span class="string">&quot;RabbitMQ&quot;</span>));</span><br><span class="line">            <span class="comment">// 注册事件总线服务</span></span><br><span class="line">            services.AddEventBus(initOptions.EventBusQueueName, assemblies);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 从配置中获取 Redis 连接字符串</span></span><br><span class="line">            <span class="built_in">string</span> redisConnStr = configuration.GetValue&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;Redis:ConnStr&quot;</span>);</span><br><span class="line">            <span class="comment">// 创建 Redis 连接多路复用器</span></span><br><span class="line">            IConnectionMultiplexer redisConnMultiplexer = ConnectionMultiplexer.Connect(redisConnStr);</span><br><span class="line">            <span class="comment">// 注册 Redis 连接为单例服务</span></span><br><span class="line">            services.AddSingleton(<span class="keyword">typeof</span>(IConnectionMultiplexer), redisConnMultiplexer);</span><br><span class="line">            <span class="comment">// 配置转发头部选项，支持所有转发头</span></span><br><span class="line">            services.Configure&lt;ForwardedHeadersOptions&gt;(Options =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                Options.ForwardedHeaders = ForwardedHeaders.All;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ConfigureDbConfiguration"><a href="#ConfigureDbConfiguration" class="headerlink" title="ConfigureDbConfiguration"></a>ConfigureDbConfiguration</h3><p>我们创建了一个对WebApplicationBuilder的扩展方法,读取数据库配置源。<br>将数据库作为配置源，并将其配置加载到 WebApplicationBuilder.Configuration 中，支持自动刷新。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 配置数据库配置源，将数据库中的配置信息添加到应用配置中。</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;builder&quot;&gt;</span>WebApplicationBuilder 实例。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ConfigureDbConfiguration</span>(<span class="params"><span class="keyword">this</span> WebApplicationBuilder builder</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 配置主机构建器的应用配置</span></span><br><span class="line">    builder.Host.ConfigureAppConfiguration((hostCtx, configBuilder) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 从应用配置中获取数据库连接字符串，键为 &quot;DefaultDB:ConnStr&quot;</span></span><br><span class="line">        <span class="built_in">string</span> connStr = builder.Configuration.GetValue&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;DefaultDB:ConnStr&quot;</span>);</span><br><span class="line">        <span class="comment">// 添加自定义的数据库配置源，支持自动刷新，刷新间隔为5秒</span></span><br><span class="line">        configBuilder.AddDbConfiguration(() =&gt; <span class="keyword">new</span> SqlConnection(connStr), reloadOnChange: <span class="literal">true</span>, reloadInterval: TimeSpan.FromSeconds(<span class="number">5</span>));</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中builder.Host.ConfigureAppConfiguration((hostCtx, configBuilder) &#x3D;&gt;是修改应用的主机（IHostBuilder）的配置构建逻辑。<br>这是对应用配置系统进行扩展（而不是仅仅修改运行时服务）。<br><b>hostCtx 是当前主机的上下文；configBuilder 是正在构建的配置。</b></p>
<p>而configBuilder.AddDbConfiguration中的<b>AddDbConfiguration</b>是作用是从数据库中读取配置项，作为应用配置源之一添加到 Configuration 中。<br><b>() &#x3D;&gt; new SqlConnection(connStr)</b>是一个延迟执行的委托，当配置系统需要刷新或初始化时才会创建连接对象，<b>避免启动时立即连接数据库</b>。<br><b>reloadOnChange: true</b>启用自动刷新配置功能，意思是当<b>数据库中的配置值发生变更时，可以自动重新加载，不重启服务</b>。<br><b>reloadInterval: TimeSpan.FromSeconds(5)</b>配置刷新周期为 5 秒，即配置系统每隔 5 秒去检查数据库配置是否有变更，如果有则刷新。</p>
<p><b>数据库变成了应用的一个配置源，优先级可能比 appsettings.json 高（取决于添加顺序）。</b></p>
<h3 id="ConfigureExtraServices"><a href="#ConfigureExtraServices" class="headerlink" title="ConfigureExtraServices"></a>ConfigureExtraServices</h3><p>ConfigureExtraServices配置了配置应用所需的额外服务，包括数据库、认证、授权、日志、CORS、Redis、事件总线等。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ConfigureExtraServices</span>(<span class="params"><span class="keyword">this</span> WebApplicationBuilder builder, InitializerOptions initOptions</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 获取服务集合</span></span><br><span class="line">    IServiceCollection services = builder.Services;</span><br><span class="line">    <span class="comment">// 获取应用配置</span></span><br><span class="line">    IConfiguration configuration = builder.Configuration;</span><br><span class="line">    <span class="comment">// 获取所有引用的程序集，用于后续模块初始化和依赖注入</span></span><br><span class="line">    <span class="keyword">var</span> assemblies = ReflectionHelper.GetAllReferencedAssemblies();</span><br><span class="line">    <span class="comment">// 执行所有模块的初始化方法</span></span><br><span class="line">    services.RunModuleInitializers(assemblies);</span><br><span class="line">    <span class="comment">// 注册所有数据库上下文，使用 SQL Server，连接字符串从配置中获取</span></span><br><span class="line">    services.AddAllDbContexts(ctx =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">string</span> connStr = configuration.GetValue&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;DefaultDB:ConnStr&quot;</span>);</span><br><span class="line">        ctx.UseSqlServer(connStr);</span><br><span class="line">    &#125;, assemblies);</span><br></pre></td></tr></table></figure>

<p>IServiceCollection services &#x3D; builder.Services从 WebApplicationBuilder 中获取服务注册容器（IServiceCollection），用于注册依赖后续所有的依赖注入（AddScoped、AddDbContext 等）都会往这个集合中注册。</p>
<p>IConfiguration configuration &#x3D; builder.Configuration获取应用程序的配置系统接口（例如 appsettings.json、环境变量、命令行等）后续可通过 configuration.GetValue&lt;string&gt;(“xxx”) 方式读取配置值</p>
<p>var assemblies &#x3D; ReflectionHelper.GetAllReferencedAssemblies()中的ReflectionHelper.GetAllReferencedAssemblies()是用于通过反射获取当前项目引用的所有程序集（Assembly）</p>
<p>services.RunModuleInitializers(assemblies)这是一个模块化系统的入口，会从传入的 assemblies 中寻找实现了某个约定接口（例如 IModuleInitializer）的类，并调用其初始化方法。</p>
<p>services.AddAllDbContexts(ctx &#x3D;&gt;从配置中读取数据库连接字符串，在多个程序集内查找所有继承自 DbContext 的类，自动为这些 DbContext 注册到 DI 容器中，统一使用 UseSqlServer(…) 进行数据库配置。</p>
<p>而ReflectionHelper.GetAllReferencedAssemblies()、RunModuleInitializers()、AddAllDbContexts,都是自定义的扩展方法。</p>
<h4 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加认证服务</span></span><br><span class="line">builder.Services.AddAuthentication();</span><br><span class="line"><span class="comment">// 添加授权服务</span></span><br><span class="line">builder.Services.AddAuthorization();</span><br><span class="line"><span class="comment">// 从配置中获取 JWT 相关配置</span></span><br><span class="line">JWTOptions jwtOpt = configuration.GetSection(<span class="string">&quot;JWT&quot;</span>).Get&lt;JWTOptions&gt;();</span><br><span class="line"><span class="comment">// 添加 JWT 认证服务</span></span><br><span class="line">builder.Services.AddJWTAuthentication(jwtOpt);</span><br><span class="line"><span class="comment">// 配置 Swagger，添加认证头部</span></span><br><span class="line">builder.Services.Configure&lt;SwaggerGenOptions&gt;(c =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    c.AddAuthenticationHeader();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>其中的JWTOptions是JWT 配置选项类，用于存储生成和验证 JWT 所需的参数。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">YU.JWT</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> JWT 配置选项类，用于存储生成和验证 JWT 所需的参数。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">JWTOptions</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 令牌颁发者（Issuer）。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Issuer &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 令牌接收者（Audience）。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Audience &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 用于签名 JWT 的密钥。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Key &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 令牌过期时间（秒）。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> ExpireSeconds &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而配置JWT还要配置配置JWT令牌验证和添加在 Swagger 文档中添加认证头部信息，分别对这两个配置封装为AddJWTAuthentication、AddAuthenticationHeader扩展方法。</p>
<p><b>AddJWTAuthentication</b></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">YU.JWT</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 提供JWT认证相关的扩展方法。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">AuthenticationExtensions</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 向服务集合中添加JWT认证。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;services&quot;&gt;</span>服务集合。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;jwtOpt&quot;&gt;</span>JWT配置选项。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>认证生成器。<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AuthenticationBuilder <span class="title">AddJWTAuthentication</span>(<span class="params"><span class="keyword">this</span> IServiceCollection services, JWTOptions jwtOpt</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)</span><br><span class="line">            .AddJwtBearer(x =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 配置JWT令牌验证参数</span></span><br><span class="line">                x.TokenValidationParameters = <span class="keyword">new</span>()</span><br><span class="line">                &#123;</span><br><span class="line">                    ValidateIssuer = <span class="literal">true</span>, <span class="comment">// 验证签发者</span></span><br><span class="line">                    ValidateAudience = <span class="literal">true</span>, <span class="comment">// 验证接收者</span></span><br><span class="line">                    ValidateLifetime = <span class="literal">true</span>, <span class="comment">// 验证有效期</span></span><br><span class="line">                    ValidateIssuerSigningKey = <span class="literal">true</span>, <span class="comment">// 验证签名密钥</span></span><br><span class="line">                    ValidIssuer = jwtOpt.Issuer, <span class="comment">// 有效签发者</span></span><br><span class="line">                    ValidAudience = jwtOpt.Audience, <span class="comment">// 有效接收者</span></span><br><span class="line">                    IssuerSigningKey = <span class="keyword">new</span> SymmetricSecurityKey(Encoding.UTF8.GetBytes(jwtOpt.Key)), <span class="comment">// 签名密钥</span></span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><b>AddAuthenticationHeader</b></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">YU.JWT</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> SwaggerGenOptions 的扩展方法，用于在 Swagger 文档中添加认证头部信息。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">SwaggerGenOptionsExtensions</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 向 Swagger 配置中添加认证头（Authorization Header），</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 使得在 Swagger UI 中可以输入 JWT Token 进行接口测试。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;c&quot;&gt;</span>SwaggerGenOptions 实例。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AddAuthenticationHeader</span>(<span class="params"><span class="keyword">this</span> SwaggerGenOptions c</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 添加安全定义，指定名称为 &quot;Authorization&quot;，类型为 ApiKey，位置在 Header。</span></span><br><span class="line">            <span class="comment">// 这样在 Swagger UI 中会出现一个输入框用于填写 Token。</span></span><br><span class="line">            c.AddSecurityDefinition(<span class="string">&quot;Authorization&quot;</span>, <span class="keyword">new</span> OpenApiSecurityScheme</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 描述信息，指导用户如何填写 Token。</span></span><br><span class="line">                Description = <span class="string">&quot;Authorization header .\r\n Example:&#x27;Bearer 12345abcdef&#x27;&quot;</span>,</span><br><span class="line">                <span class="comment">// 指定参数在 HTTP Header 中传递。</span></span><br><span class="line">                In = ParameterLocation.Header,</span><br><span class="line">                <span class="comment">// 安全方案类型为 ApiKey。</span></span><br><span class="line">                Type = SecuritySchemeType.ApiKey,</span><br><span class="line">                <span class="comment">// 方案名称，通常为 &quot;Authorization&quot;。</span></span><br><span class="line">                Scheme = <span class="string">&quot;Authorization&quot;</span></span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 添加安全需求，指定所有接口都需要携带 &quot;Authorization&quot; 头部。</span></span><br><span class="line">            c.AddSecurityRequirement(<span class="keyword">new</span> OpenApiSecurityRequirement()</span><br><span class="line">                &#123;</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">new</span> OpenApiSecurityScheme</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="comment">// 引用上面定义的安全方案。</span></span><br><span class="line">                            Reference = <span class="keyword">new</span> OpenApiReference</span><br><span class="line">                            &#123;</span><br><span class="line">                                Type = ReferenceType.SecurityScheme,</span><br><span class="line">                                Id=<span class="string">&quot;Authorization&quot;</span></span><br><span class="line">                            &#125;,</span><br><span class="line">                            <span class="comment">// 方案类型为 oauth2（虽然实际类型为 ApiKey，这里用于兼容性）。</span></span><br><span class="line">                            Scheme = <span class="string">&quot;oauth2&quot;</span>,</span><br><span class="line">                            <span class="comment">// 头部名称。</span></span><br><span class="line">                            Name=<span class="string">&quot;Authorization&quot;</span>,</span><br><span class="line">                            <span class="comment">// 参数位置为 Header。</span></span><br><span class="line">                            In=ParameterLocation.Header,</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="comment">// 作用域列表，这里为空表示不限定作用域。</span></span><br><span class="line">                        <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;()</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 配置 JWT 选项绑定</span></span><br><span class="line">services.Configure&lt;JWTOptions&gt;(configuration.GetSection(<span class="string">&quot;JWT&quot;</span>));</span><br></pre></td></tr></table></figure>
<p>这行代码的作用是将应用配置文件中的 JWT 配置节绑定到 JWTOptions 类型，并注册到依赖注入容器，方便后续通过依赖注入获取配置信息。</p>
<h4 id="MediatR"><a href="#MediatR" class="headerlink" title="MediatR"></a>MediatR</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册 MediatR，用于领域事件和命令处理</span></span><br><span class="line">services.AddMediatR(assemblies);</span><br></pre></td></tr></table></figure>

<p>而AddMediatR是对注册MediatR服务的配置和派发领域事件。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">YU.Infrastructure.EFCore</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 提供与MediatR相关的扩展方法。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">MediatorExtensions</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 扩展IServiceCollection以批量注册MediatR相关服务。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;services&quot;&gt;</span>依赖注入服务集合。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;assemblies&quot;&gt;</span>包含MediatR处理程序的程序集集合。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>服务集合本身，便于链式调用。<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IServiceCollection <span class="title">AddMediatR</span>(<span class="params"><span class="keyword">this</span> IServiceCollection services, IEnumerable&lt;Assembly&gt; assemblies</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 将指定程序集中的MediatR服务注册到依赖注入容器</span></span><br><span class="line">            <span class="keyword">return</span> services.AddMediatR(assemblies.ToArray());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 派发当前DbContext中所有聚合根的领域事件。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;mediator&quot;&gt;</span>MediatR中介者实例。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ctx&quot;&gt;</span>当前的EF Core DbContext实例。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>异步任务。<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">DispatchDomainEventsAsync</span>(<span class="params"><span class="keyword">this</span> IMediator mediator, DbContext ctx</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 获取所有实现了IDomainEvents接口且包含领域事件的实体</span></span><br><span class="line">            <span class="keyword">var</span> domainEntities = ctx.ChangeTracker</span><br><span class="line">                .Entries&lt;IDomainEvents&gt;()</span><br><span class="line">                .Where(x =&gt; x.Entity.GetDomainEvents().Any());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 收集所有领域事件</span></span><br><span class="line">            <span class="keyword">var</span> domainEvents = domainEntities</span><br><span class="line">                .SelectMany(x =&gt; x.Entity.GetDomainEvents())</span><br><span class="line">                .ToList();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 清空实体上的领域事件，避免重复派发</span></span><br><span class="line">            domainEntities.ToList()</span><br><span class="line">                .ForEach(entity =&gt; entity.Entity.ClearDomainEvents());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 逐个通过MediatR发布领域事件</span></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> domainEvent <span class="keyword">in</span> domainEvents)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">await</span> mediator.Publish(domainEvent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要实现IDomainEvents接口且包含领域事件的实体</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">YU.DomainCommons.Models</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 定义领域事件集合的接口。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 该接口用于聚合根或实体中管理领域事件的添加、去重、获取和清理操作。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 领域事件用于在领域模型内部或外部传播重要的业务状态变化。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IDomainEvents</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取当前已注册的所有领域事件。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>领域事件的只读集合。<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function">IEnumerable&lt;INotification&gt; <span class="title">GetDomainEvents</span>()</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 添加一个新的领域事件到集合中。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;eventItem&quot;&gt;</span>要添加的领域事件。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">AddDomainEvent</span>(<span class="params">INotification eventItem</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 如果集合中不存在该事件，则添加一个新的领域事件。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 用于避免重复添加相同的事件。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;eventItem&quot;&gt;</span>要添加的领域事件。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">AddDomainEventIfAbsent</span>(<span class="params">INotification eventItem</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 清空当前所有已注册的领域事件。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">ClearDomainEvents</span>()</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="筛选器（过滤器）"><a href="#筛选器（过滤器）" class="headerlink" title="筛选器（过滤器）"></a>筛选器（过滤器）</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 配置 MVC 选项，添加工作单元过滤器</span></span><br><span class="line">services.Configure&lt;MvcOptions&gt;(options =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    options.Filters.Add&lt;UnitOfWorkFilter&gt;();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>options.Filters.Add&lt;UnitOfWorkFilter&gt;()给所有的控制器动作方法添加一个全局过滤器。<br>UnitOfWorkFilter 是自定义的类，实现了IAsyncActionFilter。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">YU.ASPNETCore</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 实现基于特性（UnitOfWorkAttribute）的工作单元过滤器。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 用于在 ASP.NET Core 控制器或方法上自动管理事务和 DbContext 的 SaveChanges。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UnitOfWorkFilter</span> : <span class="title">IAsyncActionFilter</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取应用于控制器或方法的 UnitOfWorkAttribute 特性。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 优先获取控制器上的特性，如果没有则获取方法上的特性。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;actionDesc&quot;&gt;</span>当前 Action 的描述信息。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>UnitOfWorkAttribute 实例或 null。<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> UnitOfWorkAttribute? GetUoWAttr(ActionDescriptor actionDesc)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> caDesc = actionDesc <span class="keyword">as</span> ControllerActionDescriptor;</span><br><span class="line">            <span class="keyword">if</span> (caDesc == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 不是控制器 Action，直接返回 null</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 优先获取控制器上的 UnitOfWorkAttribute</span></span><br><span class="line">            <span class="keyword">var</span> uowAttr = caDesc.ControllerTypeInfo</span><br><span class="line">                .GetCustomAttribute&lt;UnitOfWorkAttribute&gt;();</span><br><span class="line">            <span class="keyword">if</span> (uowAttr != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> uowAttr;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 如果控制器上没有，则获取方法上的 UnitOfWorkAttribute</span></span><br><span class="line">                <span class="keyword">return</span> caDesc.MethodInfo</span><br><span class="line">                    .GetCustomAttribute&lt;UnitOfWorkAttribute&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 拦截 Action 执行过程，实现工作单元事务控制。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;context&quot;&gt;</span>Action 执行上下文。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;next&quot;&gt;</span>委托，执行下一个中间件或 Action。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>异步任务。<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">OnActionExecutionAsync</span>(<span class="params">ActionExecutingContext context, ActionExecutionDelegate next</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 获取当前 Action 或控制器上的 UnitOfWorkAttribute</span></span><br><span class="line">            <span class="keyword">var</span> uowAttr = GetUoWAttr(context.ActionDescriptor);</span><br><span class="line">            <span class="keyword">if</span> (uowAttr == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 未标记 UnitOfWorkAttribute，直接执行下一个中间件</span></span><br><span class="line">                <span class="keyword">await</span> next();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 启用支持异步流的事务作用域</span></span><br><span class="line">            <span class="keyword">using</span> TransactionScope txScope = <span class="keyword">new</span> TransactionScope(TransactionScopeAsyncFlowOption.Enabled);</span><br><span class="line">            List&lt;DbContext&gt; dbCtxs = <span class="keyword">new</span> List&lt;DbContext&gt;();</span><br><span class="line">            <span class="comment">// 遍历特性中声明的所有 DbContext 类型</span></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> dbCtxType <span class="keyword">in</span> uowAttr.DbContextTypes)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 通过依赖注入获取 DbContext 实例</span></span><br><span class="line">                <span class="keyword">var</span> sp = context.HttpContext.RequestServices;</span><br><span class="line">                DbContext dbCtx = (DbContext)sp.GetRequiredService(dbCtxType);</span><br><span class="line">                dbCtxs.Add(dbCtx);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 执行 Action</span></span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">await</span> next();</span><br><span class="line">            <span class="keyword">if</span> (result.Exception == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 如果没有异常，依次保存所有 DbContext 的更改</span></span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> dbCtx <span class="keyword">in</span> dbCtxs)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">await</span> dbCtx.SaveChangesAsync();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 提交事务</span></span><br><span class="line">                txScope.Complete();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果有异常，事务会自动回滚</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="序列化转换器"><a href="#序列化转换器" class="headerlink" title="序列化转换器"></a>序列化转换器</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 配置 JSON 选项，添加自定义的 DateTime 序列化转换器</span></span><br><span class="line">services.Configure&lt;JsonOptions&gt;(options =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//设置时间格式。而非“2008-08-08T08:08:08”这样的格式,而是&quot;2008-08-08 08:08:08&quot;</span></span><br><span class="line">    options.JsonSerializerOptions.Converters.Add(<span class="keyword">new</span> DateTimeJsonConverter(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>会替换默认的 DateTime 序列化规则。<br>options.JsonSerializerOptions.Converters.Add(…)添加一个自定义的JsonConverter&lt;DateTime&amp;gt，DateTimeJsonConverter</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">YU.Commons.JsonConverters</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 自定义的 DateTime 类型 JSON 序列化与反序列化转换器。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 支持指定日期时间格式进行序列化与反序列化。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DateTimeJsonConverter</span> : <span class="title">JsonConverter</span>&lt;<span class="title">DateTime</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 日期时间格式字符串。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> <span class="built_in">string</span> _dateFormatString;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 默认构造函数，使用 &quot;yyyy-MM-dd HH:mm:ss&quot; 作为日期时间格式。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DateTimeJsonConverter</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            _dateFormatString = <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>; <span class="comment">// 默认日期格式</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数，允许自定义日期时间格式。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;dateformatString&quot;&gt;</span>自定义的日期时间格式字符串<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DateTimeJsonConverter</span>(<span class="params"><span class="built_in">string</span> dateformatString</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _dateFormatString = dateformatString; <span class="comment">// 使用自定义日期格式</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 反序列化：将 JSON 字符串转换为 DateTime 对象。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;reader&quot;&gt;</span>JSON 读取器<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;typeToConvert&quot;&gt;</span>要转换的类型<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;options&quot;&gt;</span>序列化选项<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>反序列化得到的 DateTime 对象<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> DateTime <span class="title">Read</span>(<span class="params"><span class="keyword">ref</span> Utf8JsonReader reader, Type typeToConvert, JsonSerializerOptions options</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span>? str = reader.GetString();</span><br><span class="line">            <span class="keyword">if</span> (str == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 如果 JSON 字符串为 null，则返回默认值</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">default</span>(DateTime);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 将字符串解析为 DateTime 对象</span></span><br><span class="line">                <span class="keyword">return</span> DateTime.Parse(str);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 序列化：将 DateTime 对象转换为指定格式的 JSON 字符串。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;writer&quot;&gt;</span>JSON 写入器<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;value&quot;&gt;</span>要序列化的 DateTime 值<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;options&quot;&gt;</span>序列化选项<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Write</span>(<span class="params">Utf8JsonWriter writer, DateTime <span class="keyword">value</span>, JsonSerializerOptions options</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 按指定格式将 DateTime 写入为字符串</span></span><br><span class="line">            writer.WriteStringValue(<span class="keyword">value</span>.ToString(_dateFormatString));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Cors"><a href="#Cors" class="headerlink" title="Cors"></a>Cors</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 配置跨域资源共享（CORS）策略</span></span><br><span class="line">services.AddCors(options =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 从配置中获取 CORS 设置</span></span><br><span class="line">    <span class="keyword">var</span> corsOpt = configuration.GetSection(<span class="string">&quot;Cors&quot;</span>).Get&lt;CorsSettings&gt;();</span><br><span class="line">    <span class="comment">// 获取允许的来源列表</span></span><br><span class="line">    <span class="built_in">string</span>[] urls = corsOpt.Origins;</span><br><span class="line">    <span class="comment">// 添加默认策略，允许指定来源、任意头、任意方法，并允许携带凭据</span></span><br><span class="line">    options.AddDefaultPolicy(builder =&gt; builder.WithOrigins(urls)</span><br><span class="line">        .AllowAnyHeader()</span><br><span class="line">        .AllowAnyMethod()</span><br><span class="line">        .AllowCredentials());</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>注意：AllowCredentials() 和 WithOrigins(…) 必须一起使用，不能搭配 AllowAnyOrigin()，否则会抛出异常。</p>
<h4 id="日志服务"><a href="#日志服务" class="headerlink" title="日志服务"></a>日志服务</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 配置日志服务，使用 Serilog，日志输出到控制台和文件</span></span><br><span class="line">services.AddLogging(builder =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 配置 Serilog 日志记录器</span></span><br><span class="line">    Log.Logger = <span class="keyword">new</span> LoggerConfiguration()</span><br><span class="line">    .WriteTo.Console()</span><br><span class="line">    .WriteTo.File(initOptions.LogFilePath)</span><br><span class="line">    .CreateLogger();</span><br><span class="line">    <span class="comment">// 将 Serilog 集成到日志系统</span></span><br><span class="line">    builder.AddSerilog();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="验证器"><a href="#验证器" class="headerlink" title="验证器"></a>验证器</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取应用程序主程序集，用于注册 FluentValidation 验证器</span></span><br><span class="line"><span class="keyword">var</span> applicationAssembly = <span class="keyword">typeof</span>(UserModelValidator).Assembly;</span><br><span class="line"><span class="comment">// 注册所有验证器</span></span><br><span class="line">services.AddValidatorsFromAssembly(applicationAssembly);</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">YU.ASPNETCore</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 用户模型验证器，使用FluentValidation对UserValidation对象进行属性校验。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserModelValidator</span> : <span class="title">AbstractValidator</span>&lt;<span class="title">UserValidation</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数，定义了对UserValidation属性的校验规则。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">UserModelValidator</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 校验用户名不能为空</span></span><br><span class="line">            RuleFor(x =&gt; x.Name)</span><br><span class="line">                .NotEmpty()</span><br><span class="line">                .WithMessage(<span class="string">&quot;用户名不能为空&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 校验年龄必须在0到100之间</span></span><br><span class="line">            RuleFor(x =&gt; x.Age)</span><br><span class="line">                .InclusiveBetween(<span class="number">0</span>, <span class="number">100</span>)</span><br><span class="line">                .WithMessage(<span class="string">&quot;年龄必须在0到100之间&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">YU.DomainCommons.Models</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 用户验证信息模型。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserValidation</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 用户名。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 用户年龄。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Age &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过某个验证器类型 UserModelValidator 获取它所在的程序集（Assembly）。<br>这样就能知道“应用程序的主要代码程序集”，用于后续自动扫描和注册。</p>
<h4 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 配置 RabbitMQ 事件总线选项绑定</span></span><br><span class="line">services.Configure&lt;IntegrationEventRabbitMQOptions&gt;(configuration.GetSection(<span class="string">&quot;RabbitMQ&quot;</span>));</span><br></pre></td></tr></table></figure>
<p>将配置文件中 “RabbitMQ” 节点的内容绑定到 IntegrationEventRabbitMQOptions 类，并注入到依赖注入容器中。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">YU.EventBus</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 表示用于配置RabbitMQ集成事件的选项。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">IntegrationEventRabbitMQOptions</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> RabbitMQ 主机名或 IP 地址。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> HostName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 交换机名称。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> ExchangeName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 用于连接 RabbitMQ 的用户名（可选）。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? UserName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 用于连接 RabbitMQ 的密码（可选）。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Password &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册事件总线服务</span></span><br><span class="line">services.AddEventBus(initOptions.EventBusQueueName, assemblies);</span><br></pre></td></tr></table></figure>

<p>注册事件总线（EventBus）服务，并初始化事件处理器扫描、队列名称等设置。</p>
<p>initOptions.EventBusQueueName<br>当前服务的事件队列名，例如 “user-service”。<br>不同服务应该有不同的队列名，防止消费互串。</p>
<p>assemblies<br>所有需要扫描的程序集（Assembly[]），用于从中找出所有实现了 IIntegrationEventHandler&lt;T&gt; 的事件处理器。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">YU.EventBus</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 扩展 IServiceCollection，提供事件总线（EventBus）相关的依赖注入注册方法。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">ServicesCollectionExtensions</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 注册事件总线服务，自动扫描指定程序集中的事件处理器类型。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;services&quot;&gt;</span>依赖注入服务集合。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;queueName&quot;&gt;</span>RabbitMQ 队列名称。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;assemblies&quot;&gt;</span>要扫描的程序集列表。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>服务集合本身，便于链式调用。<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IServiceCollection <span class="title">AddEventBus</span>(<span class="params"><span class="keyword">this</span> IServiceCollection services, <span class="built_in">string</span> queueName,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">params</span> Assembly[] assemblies</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 将 params 形式的程序集数组转换为 List 形式，调用重载方法</span></span><br><span class="line">            <span class="keyword">return</span> AddEventBus(services, queueName, assemblies.ToList());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 注册事件总线服务，自动扫描指定程序集中的事件处理器类型。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;services&quot;&gt;</span>依赖注入服务集合。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;queueName&quot;&gt;</span>RabbitMQ 队列名称。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;assemblies&quot;&gt;</span>要扫描的程序集集合。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>服务集合本身，便于链式调用。<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IServiceCollection <span class="title">AddEventBus</span>(<span class="params"><span class="keyword">this</span> IServiceCollection services, <span class="built_in">string</span> queueName,</span></span></span><br><span class="line"><span class="params"><span class="function">            IEnumerable&lt;Assembly&gt; assemblies</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 用于存储所有扫描到的事件处理器类型</span></span><br><span class="line">            List&lt;Type&gt; eventHandlers = <span class="keyword">new</span> List&lt;Type&gt;();</span><br><span class="line">            <span class="comment">// 遍历每个程序集</span></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> asm <span class="keyword">in</span> assemblies)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 查找所有非抽象且实现了 IIntegrationEventHandler 接口的类型</span></span><br><span class="line">                <span class="keyword">var</span> types = asm.GetTypes().Where(t =&gt; t.IsAbstract == <span class="literal">false</span> &amp;&amp; t.IsAssignableTo(<span class="keyword">typeof</span>(IIntegrationEventHandler)));</span><br><span class="line">                <span class="comment">// 添加到事件处理器类型列表</span></span><br><span class="line">                eventHandlers.AddRange(types);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 调用重载方法，注册事件处理器类型</span></span><br><span class="line">            <span class="keyword">return</span> AddEventBus(services, queueName, eventHandlers);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 注册事件总线服务，并将指定的事件处理器类型注册到依赖注入容器。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;services&quot;&gt;</span>依赖注入服务集合。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;queueName&quot;&gt;</span>RabbitMQ 队列名称。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;eventHandlerTypes&quot;&gt;</span>事件处理器类型集合。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>服务集合本身，便于链式调用。<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IServiceCollection <span class="title">AddEventBus</span>(<span class="params"><span class="keyword">this</span> IServiceCollection services, <span class="built_in">string</span> queueName,</span></span></span><br><span class="line"><span class="params"><span class="function">            IEnumerable&lt;Type&gt; eventHandlerTypes</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 遍历所有事件处理器类型</span></span><br><span class="line">            <span class="keyword">foreach</span> (Type type <span class="keyword">in</span> eventHandlerTypes)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 将事件处理器类型注册为 Scoped 生命周期</span></span><br><span class="line">                services.AddScoped(type, type);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 注册 IEventBus 单例服务</span></span><br><span class="line">            services.AddSingleton&lt;IEventBus&gt;(sp =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 获取 RabbitMQ 配置选项</span></span><br><span class="line">                <span class="keyword">var</span> optionMQ = sp.GetRequiredService&lt;IOptions&lt;IntegrationEventRabbitMQOptions&gt;&gt;().Value;</span><br><span class="line">                <span class="comment">// 创建 RabbitMQ 连接工厂</span></span><br><span class="line">                <span class="keyword">var</span> factory = <span class="keyword">new</span> ConnectionFactory()</span><br><span class="line">                &#123;</span><br><span class="line">                    HostName = optionMQ.HostName, <span class="comment">// 设置主机名</span></span><br><span class="line">                    DispatchConsumersAsync = <span class="literal">true</span> <span class="comment">// 启用异步消费者</span></span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="comment">// 如果配置了用户名，则设置用户名</span></span><br><span class="line">                <span class="keyword">if</span> (optionMQ.UserName != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    factory.UserName = optionMQ.UserName;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 如果配置了密码，则设置密码</span></span><br><span class="line">                <span class="keyword">if</span> (optionMQ.Password != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    factory.Password = optionMQ.Password;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 创建 RabbitMQ 持久连接对象</span></span><br><span class="line">                RabbitMQConnection mqConnection = <span class="keyword">new</span> RabbitMQConnection(factory);</span><br><span class="line">                <span class="comment">// 获取服务作用域工厂，用于事件处理器的依赖注入</span></span><br><span class="line">                <span class="keyword">var</span> serviceScopeFactory = sp.GetRequiredService&lt;IServiceScopeFactory&gt;();</span><br><span class="line">                <span class="comment">// 创建 RabbitMQEventBus 实例</span></span><br><span class="line">                <span class="keyword">var</span> eventBus = <span class="keyword">new</span> RabbitMQEventBus(mqConnection, serviceScopeFactory, optionMQ.ExchangeName, queueName);</span><br><span class="line">                <span class="comment">// 返回事件总线实例</span></span><br><span class="line">                <span class="keyword">return</span> eventBus;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">// 返回服务集合本身</span></span><br><span class="line">            <span class="keyword">return</span> services;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>IIntegrationEventHandler定义集成事件处理程序的接口</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">YU.EventBus</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 定义集成事件处理程序的接口。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IIntegrationEventHandler</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 处理集成事件的方法。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;eventName&quot;&gt;</span>事件名称。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;eventData&quot;&gt;</span>事件数据（序列化后的字符串）。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>表示异步操作的任务。<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function">Task <span class="title">Handle</span>(<span class="params"><span class="built_in">string</span> eventName, <span class="built_in">string</span> eventData</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>IntegrationEventRabbitMQOptions接口自定义用于配置RabbitMQ集成事件的选项。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">YU.EventBus</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 表示用于配置RabbitMQ集成事件的选项。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">IntegrationEventRabbitMQOptions</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> RabbitMQ 主机名或 IP 地址。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> HostName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 交换机名称。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> ExchangeName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 用于连接 RabbitMQ 的用户名（可选）。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? UserName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 用于连接 RabbitMQ 的密码（可选）。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Password &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从配置中获取 Redis 连接字符串</span></span><br><span class="line"><span class="built_in">string</span> redisConnStr = configuration.GetValue&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;Redis:ConnStr&quot;</span>);</span><br><span class="line"><span class="comment">// 创建 Redis 连接多路复用器</span></span><br><span class="line">IConnectionMultiplexer redisConnMultiplexer = ConnectionMultiplexer.Connect(redisConnStr);</span><br><span class="line"><span class="comment">// 注册 Redis 连接为单例服务</span></span><br><span class="line">services.AddSingleton(<span class="keyword">typeof</span>(IConnectionMultiplexer), redisConnMultiplexer);</span><br><span class="line"><span class="comment">// 配置转发头部选项，支持所有转发头</span></span><br><span class="line">services.Configure&lt;ForwardedHeadersOptions&gt;(Options =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    Options.ForwardedHeaders = ForwardedHeaders.All;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">YOUXIANYU</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2025/07/31/asp.net%20core/%E5%AD%A6%E8%8B%B1%E8%AF%AD%E7%BD%91%E7%AB%99%E9%A1%B9%E7%9B%AE/%E5%AD%A6%E8%8B%B1%E8%AF%AD%E7%BD%91%E7%AB%991%E9%98%B6%E6%AE%B5/">http://example.com/2025/07/31/asp.net%20core/%E5%AD%A6%E8%8B%B1%E8%AF%AD%E7%BD%91%E7%AB%99%E9%A1%B9%E7%9B%AE/%E5%AD%A6%E8%8B%B1%E8%AF%AD%E7%BD%91%E7%AB%991%E9%98%B6%E6%AE%B5/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="http://example.com" target="_blank">YOUXIANYU</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ASP-NET-Core/">ASP.NET Core</a></div><div class="post-share"><div class="social-share" data-image="/img%5Cyouxin%5Cnet.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/07/30/asp.net%20core/%E8%8B%B1%E8%AF%AD/%E9%9D%9E%E8%B0%93%E8%AF%AD2%EF%BC%8C%E7%8B%AC%E7%AB%8B%E4%B8%BB%E6%A0%BC/" title="非谓语2+独立主格"><img class="cover" src="/img%5CEnglish.png" onerror="onerror=null;src='/img/loading.svg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">非谓语2+独立主格</div></div><div class="info-2"><div class="info-item-1">非谓语2+独立主格非谓语&#x3D;to do ,doing主动（持续进行），done被动（完成） 1.站在树下的Tom看着天空。主干：Tom looks at the sky.Tom standing under the tree looks at the sky.可以变为非限定性定语从句(状语)：Tom, who is standing under the tree, looks at the sky.状语&#x3D;随便放（只要说得通）Standing under the tree, Tom looks at the sky.这句话还可以变为：Tom站在树下,看着天空。(用and连词)Tom stands under the tree and looks at the sky.And连接两个句子可以有两个谓语（stands, looks）And&#x3D;&gt; , 变成一句话只能有一个谓语Tom standing under the tree, looks at the sky. 2.Tom站在树下，Marry看着天空。Tom stands under the...</div></div></div></a><a class="pagination-related" href="/2025/08/01/asp.net%20core/%E8%8B%B1%E8%AF%AD/%E9%9D%9E%E8%B0%93%E8%AF%AD3,to%20do/" title="非谓语3+如何使用to do"><img class="cover" src="/img%5CEnglish.png" onerror="onerror=null;src='/img/loading.svg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">非谓语3+如何使用to do</div></div><div class="info-2"><div class="info-item-1">非谓语3+如何使用to doto go表示目的或将来1.明天将要举行的会议取消了。独立名词前面要+the this that a an主干：The meeting is canceled.The meeting to be held tomorrow is canceled. 2.我用笔来写文章。用和写都是谓语，一句一谓，写做非谓语。写表目的，用to  do。I use the pen to write an article.  为了写篇好文章，我读了很多书。写篇好文章是目的，用to do.我读了很多书:现在完成时。I have read many books.To write a good article, I have read many books.  4.我去健身房锻炼。I go to the gym to exercise 5.下一列到站的火车是从纽约来的。主干：the train is from New York。The next train to arrive is from New York. 习题我去市场买苹果。I go to the market to...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/07/01/DDD/DDD%E5%AE%9E%E6%88%98-%E9%A1%B9%E7%9B%AE%E5%88%86%E5%B1%82/" title="整洁架构"><img class="cover" src="/img%5Cyouxin%5Cwpf.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-01</div><div class="info-item-2">整洁架构</div></div><div class="info-2"><div class="info-item-1">实现整洁架构项目分层这个案例分为Users.Domain、Users.Infrastructure、Users.WebAPI这三个项目。 Users.Domain是领域层项目，主要包含实体类、值对象、领域事件数据类、领域服务、仓储接口、防腐层接口等； Users.Infrastructure是基础设施项目，主要包含实体类的配置、上下文类的定义、仓储服务、防腐层接口的实现、基础工具类等； Users.WebAPI是ASP.NET Web...</div></div></div></a><a class="pagination-related" href="/2025/05/19/DDD/EFCore%E4%B8%AD%E5%AE%9E%E7%8E%B0%E5%80%BC%E5%AF%B9%E8%B1%A1/" title=".NET Core的DDD实战-EF Core中实现值对象"><img class="cover" src="/img%5Cyouxin%5Cwpf.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-05-19</div><div class="info-item-2">.NET Core的DDD实战-EF Core中实现值对象</div></div><div class="info-2"><div class="info-item-1">EF...</div></div></div></a><a class="pagination-related" href="/2025/05/24/DDD/EFCore%E9%A2%86%E5%9F%9F%E4%BA%8B%E4%BB%B6%E7%9A%84%E5%90%88%E9%80%82%E6%97%B6%E6%9C%BARabbitMQ%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/" title=".NET Core的聚合，RabbitMQ实现领域事件"><img class="cover" src="/img%5Cyouxin%5Cwpf.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-05-24</div><div class="info-item-2">.NET Core的聚合，RabbitMQ实现领域事件</div></div><div class="info-2"><div class="info-item-1">EF...</div></div></div></a><a class="pagination-related" href="/2025/05/27/DDD/NET%20Core%208%E4%B8%AD%E4%BD%BF%E7%94%A8MassTransit/" title="ASP.NET Core使用RabbitMQ和MassTransit"><img class="cover" src="/img%5Cyouxin%5Cwpf.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-05-27</div><div class="info-item-2">ASP.NET Core使用RabbitMQ和MassTransit</div></div><div class="info-2"><div class="info-item-1">MassTransit一、MassTransit  基本概念定位：基于 .NET 平台 的开源消息总线框架，用于构建分布式、异步通信的应用程序，支持多种消息传输协议（如 RabbitMQ、Azure Service Bus、Kafka 等）。设计目标：简化分布式系统中消息传递的开发，提供高层次的抽象（如消费者、管道、 Saga 模式等），降低开发者对消息中间件底层细节的依赖。 核心特点多传输协议支持：可无缝集成 RabbitMQ、Azure Service Bus、Kafka、ActiveMQ 等多种消息代理。编程模型友好：基于 C# 语言，支持依赖注入（DI）和 Lambda 表达式，代码简洁易读。内置消费者管道（Consumer Pipeline），支持消息过滤、重试、日志记录等中间件。分布式事务支持：通过 Saga 模式 实现长流程事务的异步协调（如订单状态更新、支付回调处理）。高可用性与监控：支持消费者集群和负载均衡。集成 Prometheus、Grafana 等监控工具，提供运行时指标和健康检查。 应用场景.NET 微服务架构：作为服务间通信的核心组件（尤其适合 C#...</div></div></div></a><a class="pagination-related" href="/2025/05/15/DDD/NET%20Core%E7%9A%84DDD/" title=".NET Core的DDD架构"><img class="cover" src="/img%5Cyouxin%5Cwpf.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-05-15</div><div class="info-item-2">.NET Core的DDD架构</div></div><div class="info-2"><div class="info-item-1">...</div></div></div></a><a class="pagination-related" href="/2025/05/22/DDD/%E5%A6%82%E4%BD%95%E5%AE%89%E8%A3%85RabbitMQ/" title="如何安装RabbitMQ服务器"><img class="cover" src="/img%5Crabbitmq.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-05-22</div><div class="info-item-2">如何安装RabbitMQ服务器</div></div><div class="info-2"><div class="info-item-1">在Windows安装RabbitMQ安装RabbitMQ需要安装Erlang环境,网址：Downloads - Erlang&#x2F;OTP 下载对应的版本RabbitMQ Erlang Version Requirements — RabbitMQ 配置Erlang环境变量 在搜索框里输入编辑系统环境变量.  变量名一定要写成ERLANG_HOME，变量值就是你的Erlang的安装路径     还需要在系统变量中选中Path进行编辑，新建一个%ERLANG_HOME%\bin  打开命令窗口，输入erl或者erl -version()验证环境是否配置成功（出现以下版本号即成功，显示不是内部命令则环境变量配置失败）    安装RabbitMQ RabbitMQ官网下载址：Installing on Windows — RabbitMQ    配置RabbitMQ环境变量     进入sbin文件下，打开命令窗口输入1rabbitmq-plugins enable...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BD%91%E7%AB%99%E7%BB%93%E6%9E%84%E8%AF%B4%E6%98%8E"><span class="toc-number">1.</span> <span class="toc-text">网站结构说明</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84%E8%AF%B4%E6%98%8E"><span class="toc-number">2.</span> <span class="toc-text">项目结构说明</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">3.</span> <span class="toc-text">项目运行环境搭建</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Commons"><span class="toc-number">4.</span> <span class="toc-text">Commons</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E6%BA%90%E7%A0%81"><span class="toc-number">4.0.1.</span> <span class="toc-text">项目源码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%80%E7%94%A8%E5%88%B0%E7%9A%84NuGet%E5%8C%85"><span class="toc-number">4.1.</span> <span class="toc-text">所用到的NuGet包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ApplicationBuilderExtensions"><span class="toc-number">4.2.</span> <span class="toc-text">ApplicationBuilderExtensions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CorsSettings"><span class="toc-number">4.3.</span> <span class="toc-text">CorsSettings</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DbContextOptionsBuilderFactory"><span class="toc-number">4.4.</span> <span class="toc-text">DbContextOptionsBuilderFactory</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#InitializerOptions"><span class="toc-number">4.5.</span> <span class="toc-text">InitializerOptions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WebApplicationBuilderExtensions"><span class="toc-number">4.6.</span> <span class="toc-text">WebApplicationBuilderExtensions</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ConfigureDbConfiguration"><span class="toc-number">4.6.1.</span> <span class="toc-text">ConfigureDbConfiguration</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ConfigureExtraServices"><span class="toc-number">4.6.2.</span> <span class="toc-text">ConfigureExtraServices</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JWT"><span class="toc-number">4.6.2.1.</span> <span class="toc-text">JWT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MediatR"><span class="toc-number">4.6.2.2.</span> <span class="toc-text">MediatR</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AD%9B%E9%80%89%E5%99%A8%EF%BC%88%E8%BF%87%E6%BB%A4%E5%99%A8%EF%BC%89"><span class="toc-number">4.6.2.3.</span> <span class="toc-text">筛选器（过滤器）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E8%BD%AC%E6%8D%A2%E5%99%A8"><span class="toc-number">4.6.2.4.</span> <span class="toc-text">序列化转换器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Cors"><span class="toc-number">4.6.2.5.</span> <span class="toc-text">Cors</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.6.2.6.</span> <span class="toc-text">日志服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E5%99%A8"><span class="toc-number">4.6.2.7.</span> <span class="toc-text">验证器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RabbitMQ"><span class="toc-number">4.6.2.8.</span> <span class="toc-text">RabbitMQ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6"><span class="toc-number">4.6.2.9.</span> <span class="toc-text">事件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis"><span class="toc-number">4.6.2.10.</span> <span class="toc-text">Redis</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background: white;"><div id="footer-wrap"><div id="footer-left"><div class="footer-title"><span>YOUXIANYU | </span><span class="footer-copyright">&copy;2024 - 2026 By YOUXIANYU</span></div><div class="footer-button"><a title="GitHub" target="_blank" rel="noopener" href="https://github.com/Almango"><i class="iconfont icon-GitHub"></i></a><a title="微博" target="_blank" rel="noopener" href="https://weibo.com/u/7936064867"><i class="iconfont icon-weibo"></i></a><a title="bilibili" target="_blank" rel="noopener" href="https://space.bilibili.com/1278951656?spm_id_from=333.1007.0.0"><i class="iconfont icon-bilibili"></i></a><a title="Email" target="_blank" rel="noopener" href="https://www.microsoft.com/zh-cn/microsoft-365/outlook/email-and-calendar-software-microsoft-outlook?deeplink=%2fowa%2f0%2f%3fstate%3d1%26redirectTo%3daHR0cHM6Ly9vdXRsb29rLmxpdmUuY29tL21haWwvMC8&amp;sdf=0"><i class="iconfont icon-email"></i></a><a title="RSS" href="#"><i class="iconfont icon-RSS_flat"></i></a></div><div class="wordcount"></div><span>YOUXIANYU已经写了 229.6k 字，</span><span>好像写完一本 莫泊桑 的 《一生》 了啊</span></div><div id="footer-right"><div class="footer-totop"><i class="fas fa-chevron-up" onclick="scrollToTop()"></i></div><div class="footer-info"><p>使用Hexo框架 | 基于Butterfly魔改:mango_Modify</p><a title="萌ICP备号 20240314" target="_blank" rel="noopener" href="https://icp.gov.moe/?keyword=20240314"><img src="/img/footer_moe.png" alt="备案图标" style="height: 16px;margin-right: 3px;filter: grayscale(1);"/>萌ICP备号: 20240314号</a></div><div class="footer-service"><a title="腾讯云" target="_blank" rel="noopener" href="https://cloud.tencent.com"><img alt="腾讯云" src="https://cdn.ichika.cc/typora/202211071552681.png!towebp"/></a><a title="51LA" target="_blank" rel="noopener" href="https://www.51.la"><img alt="51LA" src="https://cdn.ichika.cc/typora/202211071552427.png!towebp"/></a><a title="CC BY-NC-SA 4.0" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"><img alt="CC BY-NC-SA 4.0" src="https://cdn.ichika.cc/typora/202211071552856.png!towebp"/></a></div></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><div class="js-pjax"><script>(() => {
  let initFn = window.walineFn || null
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const destroyWaline = ele => ele.destroy()

  const initWaline = (Fn, el = document, path = window.location.pathname) => {
    const waline = Fn({
      el: el.querySelector('#waline-wrap'),
      serverURL: 'https://youxianyu.1251.win/',
      pageview: false,
      dark: 'html[data-theme="dark"]',
      comment: false,
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    if (isShuoshuo) {
      window.shuoshuoComment.destroyWaline = () => {
        destroyWaline(waline)
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }
  }

  const loadWaline = (el, path) => {
    if (initFn) initWaline(initFn, el, path)
    else {
      btf.getCSS('https://cdn.jsdelivr.net/npm/@waline/client/dist/waline.min.css')
        .then(() => import('https://cdn.jsdelivr.net/npm/@waline/client/dist/waline.min.js'))
        .then(({ init }) => {
          initFn = init || Waline.init
          initWaline(initFn, el, path)
          window.walineFn = initFn
        })
    }
  }

  if (isShuoshuo) {
    'Waline' === 'Waline'
      ? window.shuoshuoComment = { loadComment: loadWaline } 
      : window.loadOtherComment = loadWaline
    return
  }

  if ('Waline' === 'Waline' || !true) {
    if (true) btf.loadComment(document.getElementById('waline-wrap'),loadWaline)
    else setTimeout(loadWaline, 0)
  } else {
    window.loadOtherComment = loadWaline
  }
})()</script></div><script src="/js/custom.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo_v5.4.0" title=""><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" data-title="主题版本Butterfly_v3.8.2" title=""><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="https://www.jsdelivr.com/" style="margin-inline:5px" data-title="本站使用JsDelivr为静态资源提供CDN加速" title=""><img src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&amp;logo=jsDelivr" alt=""/></a><a class="github-badge" target="_blank" href="https://vercel.com/" style="margin-inline:5px" data-title="本站采用双线部署，默认线路托管于Vercel" title=""><img src="https://img.shields.io/badge/Hosted-Vercel-brightgreen?style=flat&amp;logo=Vercel" alt=""/></a><a class="github-badge" target="_blank" href="https://vercel.com/" style="margin-inline:5px" data-title="本站采用双线部署，联通线路托管于Coding" title=""><img src="https://img.shields.io/badge/Hosted-Coding-0cedbe?style=flat&amp;logo=Codio" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="本站项目由Github托管" title=""><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&amp;logo=GitHub" alt=""/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可" title=""><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a><a class="github-badge" target="_blank" href="https://icp.gov.moe/?keyword=20240314" style="margin-inline:5px" data-title="萌ICP备 纯属萌友网站联萌！" title=""><img src="https://img.shields.io/badge/%E8%90%8CICP%E5%A4%87-20240314-fe1384?style-flat&amp;logo=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAABS2lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDIgNzkuMTYwOTI0LCAyMDE3LzA3LzEzLTAxOjA2OjM5ICAgICAgICAiPgogPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIi8+CiA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgo8P3hwYWNrZXQgZW5kPSJyIj8+nhxg7wAAByxJREFUSInl1nlwVeUZx/HPuTckkD0kQFiCEEIUlNUCAqKoSBV1AIt1ikpVLFbLONjWGUXbmWrbweJMy7hUxbbTjsUq6KCiWEvr0kE2WVK2QCKBJCxJgEASsienfxwqMob+3Zm+f93z3vM+32f5vc9z+H9bwVcfOp/YQ+1prhhEZS1VDQzqQ1MjiQmIC5Liwm3lBWpqFimrulb/7A/067vM2IsOBZ2h8MhJQW6KMDNVsKeaizKEyUlsKueqgWJ39AMJF3QpDCNYr1SaEig/lWNX2Z1h6dH5/lVyGdVIZFf7MHo9bEfh9rCg/+8NyHlN77QTsnpQ0i2y08VK+BosfhbW0cHxqmSfFd9qW+l9Pi+5WltFdGTsOBbO5dJcdh3lN5+xff0Y2zuelXjRsyYUrjOu4BVJaavlpbWIJRBLOM+J81O95AAnTtM9vNHGknut3zdT48FutJE3koWTuG4oSXH+VsInX3B9IdcVUNfCuv08t4GjO6NspOa3BNcOXx1eOugVHQnrTMkTuyWrC/BjRZO9uPYTpw7HhTWkXcLd45l9GblpHD7NWzt5ZTMXZ/OdkTy+lvR07rmcmWffq6pn9W5e/oymfcT6kJbXHiydMyVYkL/x66n+ZMcctQfjhgxl6UIGZ3Ooltd2RIZqjqKRS0ew9cFIA1cO5urlLHuPZWsZPJiZw7gqn0VT2HCIR9+jvCQhfHPrLGyE2Hng2roBxHnmJoZnc9drbD3I6QaaWkjpSVoeu4+x5XB05qMDqCenHz37UHmcFRv54ZuMeoYrB/L0DPRgZ0WfrsXVKzPX3nYykrn3dUZl8+Q0Qox/gc/L6ZlKzxQefo+UROpa6Z4VCedkPd8YyJYHI3u5T/HAShZNQxsXZfR3pCtwRW066VEeOuIUVUf77+9jTw2pycTOJml7Je1t9EgiI5X2jkgyze1fCSSdtjhBiJCkpKyuI+5oTdAtkTCgVwrbKsl8ko6QjO40tZ67EpkpdIbRf20dkbPpPTjdwsSX6I5dJYy4hoQAaZQdDy4A1iEMI613T6LtBPXJpPakrjGqc1Y6CTFq62htJp5KRwPJKWSkU3WKiiPEEqO6xgM6oZmctJhDXYH7Z59xuCyKpK6R26ZE+ys3MWYoN1/Mc5uoqmbEQJ6fTc/ulJ3i/lUc+YIfzeKhKzjVHN31A3XRHddKSrf6/6DOV3VTcw1hVKfkxOhaPDAe1UwfwmNTqT1Drxw+nE9xNXetIjHG2vnoxoT+rNrN2Of58Rp6JZ+ldKes5kjX4G7dKuikpoERfaltYnQ/DOSS3hEAFk9lXQkLnmf7Ib65lPJT3HU1+46Tm8rYvgzKYVA2h+vQIMjvewHwdSN20MiOSmZczO4a1hSzYi77T7CiiPF5JMTZexjJ5OagkwNV9M+MnJ09nKU3smgyQ3PYWoEO4fUjii4QceJmevJuMeP6csUAln4atcbSGoqOUpjD30uZNwnpHNtN3lC+NZa1xeT34pGVTJ3PL9+Ohs6GQ8gVtHZs6VLVwZhBReGwoXvt3THM/hP0SWVnCR8f4PMjkffjB/DQS8waxpHFfFgaaeHZDRRtJn0yP5tF31ymFVJ2nN27GD66KBzca2/XEWdkUpD3Fmd4tYj0FMS54Q9UnuaDUv6yE/24ewWP/DU6N/d1fvousYEs28DyLVEvGDOAt/egmSkXv2VYn3NBfpXbua6J8hMFFvy2RHsL+57gmX+w/AN651PfEDWQzLRI+afqIqOxFDJT6Rbn9Bmad3PnTH5wIxOXkJTWGiz57hCDsyqDWVldRNzeyOh+paaPfpFKnvqQX88iZwDVx0lLJqUHbe3EkZ1Odm+yUqK2GHYKmhvIG8fyeTz9IY5x67jnFPapdPDkl6jzwEF9IDjZJlgwfbG+o2u8+g4rd7D/UYI41TXnevV5K4j2q6uESckUP8rvNrH6fUH/sRXB9AlPONMSDZ8uazwoi56JjEyvdftV88jinhf4uIzmJRQOoOYgja0RKAiIBZxpjvZH5tP0c97axcLlyBXOuWZemJTYFFbUCU+1dl3j8PGSyFhnJ7EkYcWh7/njqpep5xfzWTyZZ7dEg73xOJKiGqf3YenNLBjLTz7i539COg/OvSOYO2GFo/VRG0Zwe0YX4Ns3R7NXSCxBeM8IthXfZvGf3xCWc/kkXvg2vVP4YB/rDzC1gGlDo+50/xvs2khKPrNnzAzmTH5HbzR0fkkKro93Ab5vx9kfaGgT3lLA5EyWbRpoTdHbSreOppGJV/PwlRTksK+aZz5l6z+RLBgxaau5k2cJelTKzmRQMq0d51J8UxL+23d1TDTcj7WQllZu4YwxDo+eZc22X9mwd6gN65GIFmQzampxcMOoR1xeuMbpVoqromsXdG3+wmCiekNtfSSmiUNWu2zgap+WjlZW8X11TeNkpWwICvNfCm8u3Cmxg4PN0VdmEJw7/7+0/g32RaqCbhRecAAAAABJRU5ErkJggg==" alt=""/></a></p>';
    console.log('已挂载butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><!-- hexo injector body_end end --></body></html>